name: Build (Fabric)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle (8.10.2)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.10.2

      - name: Build (auto-detect project location)
        shell: bash
        run: |
          set -euo pipefail

          # Pick gradle wrapper if present
          GRADLE_CMD="gradle"
          if [[ -x "./gradlew" ]]; then
            GRADLE_CMD="./gradlew"
          fi

          # Find project dir
          if [[ -f build.gradle || -f build.gradle.kts || -f settings.gradle || -f settings.gradle.kts ]]; then
            PROJ_DIR="."
          else
            CANDIDATE="$(find . -maxdepth 2 -type f \( -name 'build.gradle' -o -name 'build.gradle.kts' \) | head -n 1)"
            if [[ -z "${CANDIDATE}" ]]; then
              echo "❌ Gradle project not found in repository."
              exit 1
            fi
            PROJ_DIR="$(dirname "${CANDIDATE}")"
          fi

          echo "➡ Using project dir: ${PROJ_DIR}"
          "${GRADLE_CMD}" -p "${PROJ_DIR}" --version
          "${GRADLE_CMD}" -p "${PROJ_DIR}" build remapJar

      - name: List built jars (debug)
        shell: bash
        run: |
          echo "Workspace: $PWD"
          find . -type f -path '*/build/libs/*' -print || true

      - name: Upload remapped JAR (and fallback all jars)
        uses: actions/upload-artifact@v4
        with:
          name: smartmoving-fabric-jars
          path: |
            **/build/libs/*-remapped.jar
            **/build/libs/*.jar
